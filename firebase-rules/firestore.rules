rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function uid() { return request.auth.uid; }

    function userDocPath(userId) {
      return /databases/$(database)/documents/users/$(userId);
    }

    function myUserDocExists() {
      return signedIn() && exists(userDocPath(uid()));
    }

    // ✅ Admin either via Custom Claim OR via users/{uid}.role == 'admin'
    function isAdmin() {
      return signedIn() && (
        request.auth.token.admin == true
        || request.auth.token.role == 'admin'
        || (myUserDocExists() && get(userDocPath(uid())).data.role == 'admin')
      );
    }

    // ✅ Appointment participant: creator OR listed in userIds[]
    function isApptParticipant(data) {
      return signedIn() && (
        data.createdByUserId == uid()
        || ("createdForUserId" in data && data.createdForUserId == uid())
        || ("userId" in data && data.userId == uid())
        || (data.userIds is list && uid() in data.userIds)
        || ("assignedUserIds" in data && data.assignedUserIds is list && uid() in data.assignedUserIds)
      );
    }

    // -------------------- USERS --------------------
    match /users/{userId} {
      allow read: if signedIn() && (userId == uid() || isAdmin());
      allow create, update, delete: if isAdmin();
    }

    // -------------------- APPOINTMENTS (root collection) --------------------
    match /appointments/{apptId} {
      allow read: if isAdmin() || isApptParticipant(resource.data);

      allow create: if isAdmin() || (
        signedIn()
        && request.resource.data.createdByUserId == uid()
        && request.resource.data.deletedAt == null
      );

      allow update: if isAdmin() || (
        signedIn()
        && resource.data.createdByUserId == uid()
        && resource.data.deletedAt == null

        // schützt vor fremdem "Umbauen" des Termins
        && request.resource.data.createdByUserId == resource.data.createdByUserId
        && request.resource.data.startDate == resource.data.startDate
        && request.resource.data.endDate == resource.data.endDate
        && request.resource.data.title == resource.data.title
        && request.resource.data.description == resource.data.description
        && request.resource.data.appointmentType == resource.data.appointmentType
        && request.resource.data.deletedAt == resource.data.deletedAt

        // User darf nur Doku + Status open/documented
        && request.resource.data.documentationText is string
        && request.resource.data.status in ["open", "documented"]
      );

      allow delete: if false;

      match /photos/{photoId} {
        // ✅ Fotos: Admin immer, sonst ALLE Termin-Teilnehmer
        allow read: if isAdmin() || (
          signedIn()
          && isApptParticipant(get(/databases/$(database)/documents/appointments/$(apptId)).data)
          && get(/databases/$(database)/documents/appointments/$(apptId)).data.deletedAt == null
        );

        // ✅ Upload: Teilnehmer dürfen hochladen (Uploader muss der eingeloggte User sein)
        allow create: if isAdmin() || (
          signedIn()
          && isApptParticipant(get(/databases/$(database)/documents/appointments/$(apptId)).data)
          && get(/databases/$(database)/documents/appointments/$(apptId)).data.deletedAt == null
          && request.resource.data.uploadedByUserId == uid()
        );

        allow update, delete: if isAdmin();
      }
    }

    // -------------------- APPOINTMENTS (subcollections / collectionGroup) --------------------
    match /{path=**}/appointments/{apptId} {
      allow read: if isAdmin() || isApptParticipant(resource.data);

      allow create: if isAdmin() || (
        signedIn()
        && request.resource.data.createdByUserId == uid()
        && request.resource.data.deletedAt == null
      );

      allow update: if isAdmin() || (
        signedIn()
        && resource.data.createdByUserId == uid()
        && resource.data.deletedAt == null

        // schützt vor fremdem "Umbauen" des Termins
        && request.resource.data.createdByUserId == resource.data.createdByUserId
        && request.resource.data.startDate == resource.data.startDate
        && request.resource.data.endDate == resource.data.endDate
        && request.resource.data.title == resource.data.title
        && request.resource.data.description == resource.data.description
        && request.resource.data.appointmentType == resource.data.appointmentType
        && request.resource.data.deletedAt == resource.data.deletedAt

        // User darf nur Doku + Status open/documented
        && request.resource.data.documentationText is string
        && request.resource.data.status in ["open", "documented"]
      );

      allow delete: if false;

      match /photos/{photoId} {
        // ✅ Fotos: Admin immer, sonst ALLE Termin-Teilnehmer
        allow read: if isAdmin() || (
          signedIn()
          && isApptParticipant(get(/databases/$(database)/documents/$(path)/appointments/$(apptId)).data)
          && get(/databases/$(database)/documents/$(path)/appointments/$(apptId)).data.deletedAt == null
        );

        // ✅ Upload: Teilnehmer dürfen hochladen (Uploader muss der eingeloggte User sein)
        allow create: if isAdmin() || (
          signedIn()
          && isApptParticipant(get(/databases/$(database)/documents/$(path)/appointments/$(apptId)).data)
          && get(/databases/$(database)/documents/$(path)/appointments/$(apptId)).data.deletedAt == null
          && request.resource.data.uploadedByUserId == uid()
        );

        allow update, delete: if isAdmin();
      }
    }

    // -------------------- SERIES (root collection) --------------------
    match /appointmentSeries/{sid} {
      allow read: if isAdmin() || (
        signedIn() && (
          resource.data.createdForUserId == uid()
          || (resource.data.userIds is list && uid() in resource.data.userIds)
        )
      );

      allow create: if isAdmin() || (
        signedIn()
        && request.resource.data.createdForUserId == uid()
        && request.resource.data.deletedAt == null
      );

      allow update, delete: if isAdmin();
    }

    // -------------------- SERIES (subcollections / collectionGroup) --------------------
    match /{path=**}/appointmentSeries/{sid} {
      allow read: if isAdmin() || (
        signedIn() && (
          resource.data.createdForUserId == uid()
          || (resource.data.userIds is list && uid() in resource.data.userIds)
        )
      );

      allow create: if isAdmin() || (
        signedIn()
        && request.resource.data.createdForUserId == uid()
        && request.resource.data.deletedAt == null
      );

      allow update, delete: if isAdmin();
    }
  }
}
