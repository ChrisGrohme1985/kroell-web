rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function uid() { return request.auth.uid; }

    // ✅ Admin ONLY via custom claims (NO get()/exists() calls)
    function isAdmin() {
      return signedIn() && (
        request.auth.token.admin == true ||
        request.auth.token.role == 'admin'
      );
    }

    // ✅ Appointment participant: creator OR listed in any participant fields
    function isApptParticipant(data) {
      return signedIn() && (
        ("createdByUserId" in data && data.createdByUserId == uid())
        || ("createdForUserId" in data && data.createdForUserId == uid())
        || ("userId" in data && data.userId == uid())
        || ("userIds" in data && uid() in data.userIds)
        || ("assignedUserIds" in data && uid() in data.assignedUserIds)
        || ("users" in data && uid() in data.users)
        || ("participants" in data && uid() in data.participants)
        || ("participantIds" in data && uid() in data.participantIds)
        || ("userNameById" in data && data.userNameById[uid()] != null)
      );
    }

    // -------------------- USERS --------------------
    match /users/{userId} {
      allow read: if signedIn() && (userId == uid() || isAdmin());
      allow create, update, delete: if isAdmin();
    }

    // -------------------- APPOINTMENTS (root collection) --------------------
    match /appointments/{apptId} {
      allow read: if isAdmin() || isApptParticipant(resource.data);

      allow create: if isAdmin() || (
        signedIn()
        && request.resource.data.createdByUserId == uid()
        && request.resource.data.deletedAt == null
      );

      // Non-admin: only update own appointments and only doc/status.
      allow update: if isAdmin() || (
        signedIn()
        && ("createdByUserId" in resource.data) && resource.data.createdByUserId == uid()
        && resource.data.deletedAt == null
        && request.resource.data.createdByUserId == resource.data.createdByUserId
        && request.resource.data.startDate == resource.data.startDate
        && request.resource.data.endDate == resource.data.endDate
        && request.resource.data.title == resource.data.title
        && request.resource.data.description == resource.data.description
        && request.resource.data.appointmentType == resource.data.appointmentType
        && request.resource.data.deletedAt == resource.data.deletedAt
        && request.resource.data.documentationText is string
        && request.resource.data.status in ["open", "documented"]
      );

      allow delete: if false;

      match /photos/{photoId} {
        // Photos: Admin always, otherwise any appointment participant
        allow read: if isAdmin() || (
          signedIn()
          && isApptParticipant(get(/databases/$(database)/documents/appointments/$(apptId)).data)
          && get(/databases/$(database)/documents/appointments/$(apptId)).data.deletedAt == null
        );

        // Upload: participant may upload (uploader must be current user)
        allow create: if isAdmin() || (
          signedIn()
          && isApptParticipant(get(/databases/$(database)/documents/appointments/$(apptId)).data)
          && get(/databases/$(database)/documents/appointments/$(apptId)).data.deletedAt == null
          && request.resource.data.uploadedByUserId == uid()
        );

        allow update, delete: if isAdmin();
      }
    }

    // -------------------- APPOINTMENTS (subcollections / collectionGroup) --------------------
    match /{path=**}/appointments/{apptId} {
      allow read: if isAdmin() || isApptParticipant(resource.data);

      allow create: if isAdmin() || (
        signedIn()
        && request.resource.data.createdByUserId == uid()
        && request.resource.data.deletedAt == null
      );

      allow update: if isAdmin() || (
        signedIn()
        && ("createdByUserId" in resource.data) && resource.data.createdByUserId == uid()
        && resource.data.deletedAt == null
        && request.resource.data.createdByUserId == resource.data.createdByUserId
        && request.resource.data.startDate == resource.data.startDate
        && request.resource.data.endDate == resource.data.endDate
        && request.resource.data.title == resource.data.title
        && request.resource.data.description == resource.data.description
        && request.resource.data.appointmentType == resource.data.appointmentType
        && request.resource.data.deletedAt == resource.data.deletedAt
        && request.resource.data.documentationText is string
        && request.resource.data.status in ["open", "documented"]
      );

      allow delete: if false;

      match /photos/{photoId} {
        allow read: if isAdmin() || (
          signedIn()
          && isApptParticipant(get(/databases/$(database)/documents/$(path)/appointments/$(apptId)).data)
          && get(/databases/$(database)/documents/$(path)/appointments/$(apptId)).data.deletedAt == null
        );

        allow create: if isAdmin() || (
          signedIn()
          && isApptParticipant(get(/databases/$(database)/documents/$(path)/appointments/$(apptId)).data)
          && get(/databases/$(database)/documents/$(path)/appointments/$(apptId)).data.deletedAt == null
          && request.resource.data.uploadedByUserId == uid()
        );

        allow update, delete: if isAdmin();
      }
    }


    // -------------------- SERIES (root collection) --------------------
    match /appointmentSeries/{sid} {
      allow read: if isAdmin() || (
        signedIn() && (
          ("createdForUserId" in resource.data && resource.data.createdForUserId == uid())
          || ("userIds" in resource.data && uid() in resource.data.userIds)
        )
      );

      allow create: if isAdmin() || (
        signedIn()
        && request.resource.data.createdForUserId == uid()
        && request.resource.data.deletedAt == null
      );

      allow update, delete: if isAdmin();
    }

    // -------------------- SERIES (subcollections / collectionGroup) --------------------
    match /{path=**}/appointmentSeries/{sid} {
      allow read: if isAdmin() || (
        signedIn() && (
          ("createdForUserId" in resource.data && resource.data.createdForUserId == uid())
          || ("userIds" in resource.data && uid() in resource.data.userIds)
        )
      );

      allow create: if isAdmin() || (
        signedIn()
        && request.resource.data.createdForUserId == uid()
        && request.resource.data.deletedAt == null
      );

      allow update, delete: if isAdmin();
    }

  }
}
